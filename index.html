<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Muang Thong Fit Map</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#10b981" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --primary:#10b981; --dark:#111827; --muted:#6b7280; --bg:#f8fafc; --card:#ffffff;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;background:var(--bg);color:#111}
    header{padding:18px 16px 8px}
    h1{margin:0;font-size:22px}
    .sub{color:var(--muted);font-size:13px}
    .wrap{max-width:840px;margin:0 auto;padding:0 12px 64px}
    .grid{display:grid;gap:12px}
    .card{background:var(--card);border:1px solid #e5e7eb;border-radius:12px;padding:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    select,input{padding:10px;border:1px solid #e5e7eb;border-radius:10px;background:#fff}
    select,input{min-width:140px}
    button{border:0;border-radius:10px;padding:10px 14px;cursor:pointer}
    .btn-primary{background:var(--primary);color:#fff}
    .btn-ghost{background:#eef2ff;color:#111}
    .btn-danger{background:#ef4444;color:#fff}
    .muted{color:var(--muted)}
    #map{height:320px;border-radius:12px;border:1px solid #e5e7eb}
    table{width:100%;border-collapse:collapse}
    th,td{border-top:1px solid #e5e7eb;padding:8px 6px;text-align:left;font-size:14px}
    th{background:#f3f4f6}
    .legend{background:#fff;padding:6px 8px;border-radius:8px;border:1px solid #e5e7eb;font-size:12px}
    .pill{display:inline-block;background:#f3f4f6;border:1px solid #e5e7eb;padding:3px 8px;border-radius:999px;font-size:12px}
    .hide{display:none}
    .ok{color:#16a34a}
    .err{color:#b91c1c}
    .kicker{font-weight:600;margin-bottom:6px}
    .reward-btn{margin-right:8px;margin-bottom:8px}
    /* Onboarding overlay */
    #onboard{position:fixed;inset:0;background:#00000088;display:none;align-items:center;justify-content:center;padding:16px;z-index:9999}
    #onboard .panel{width:min(640px,96vw);background:#fff;border-radius:14px;border:1px solid #e5e7eb;padding:16px}
    #onboard h3{margin:6px 0 2px 0}
    #onboard label{font-size:13px;color:#374151}
    #onboard input,#onboard select{width:100%;margin:6px 0 10px 0}
  </style>
</head>
<body>
  <header class="wrap">
    <h1>Muang Thong Fit Map</h1>
    <div class="sub">PWA ‚Ä¢ Local-first ‚Ä¢ SDG3/11/17</div>
  </header>

  <!-- Onboarding -->
  <div id="onboard">
    <div class="panel">
      <h2>‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</h2>
      <div class="muted" style="margin-bottom:10px">‡∏Å‡∏£‡∏≠‡∏Å‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏à‡∏≥‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>
      <div id="onboardMsg" class="err" style="min-height:18px"></div>
      <div class="grid" style="grid-template-columns:1fr 1fr">
        <div>
          <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
          <input id="pf_name" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ" />
        </div>
        <div>
          <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label>
          <input id="pf_phone" placeholder="‡πÄ‡∏ä‡πà‡∏ô 0812345678" />
        </div>
        <div>
          <label>Gmail</label>
          <input id="pf_email" type="email" placeholder="you@gmail.com" />
        </div>
        <div>
          <label>‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</label>
          <select id="pf_goal">
            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</option>
            <option value="loss">‡∏•‡∏î‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å</option>
            <option value="fit">‡∏´‡∏∏‡πà‡∏ô‡πÄ‡∏ü‡∏¥‡∏£‡πå‡∏°</option>
            <option value="endurance">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏∂‡∏î</option>
            <option value="muscle">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡πâ‡∏≤‡∏°</option>
            <option value="health">‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏°</option>
          </select>
        </div>
        <div style="grid-column:1/-1">
          <label>‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏∏‡πà‡∏ô‡πÅ‡∏ö‡∏ö‡πÑ‡∏´‡∏ô</label>
          <input id="pf_body" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏∏‡πà‡∏ô‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡πà‡∏á / ‡∏ü‡∏¥‡∏ï‡πÄ‡∏ô‡∏™‡∏•‡∏µ‡∏ô" />
        </div>
      </div>
      <div class="row" style="justify-content:flex-end">
        <button id="btnSkipProfile" class="btn-ghost">‡∏Ç‡πâ‡∏≤‡∏°</button>
        <button id="btnSaveProfile" class="btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</button>
      </div>
    </div>
  </div>

  <main class="wrap grid">

    <!-- ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå & ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ -->
    <section class="card">
      <div class="row" style="justify-content:space-between;align-items:flex-start">
        <div>
          <div class="kicker">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</div>
          <div id="profileSummary" class="muted">-</div>
        </div>
        <div class="row">
          <span id="streakPill" class="pill">streak 0 ‡∏ß‡∏±‡∏ô</span>
          <button id="btnEditProfile" class="btn-ghost">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</button>
        </div>
      </div>
      <div id="recCard" class="card" style="margin-top:12px">
        <div class="kicker">‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
        <div id="recText">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß</div>
      </div>
    </section>

    <!-- ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà -->
    <section class="card">
      <div class="kicker">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á</div>
      <div id="map"></div>
      <div class="muted" style="margin-top:6px">‡∏´‡∏≤‡∏Å GPS ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á preset ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏™‡πà‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏≠‡∏á‡∏Ç‡πâ‡∏≤‡∏á‡∏•‡πà‡∏≤‡∏á</div>
    </section>

    <!-- ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° -->
    <section class="card">
      <div class="kicker">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</div>
      <div class="row" style="margin-bottom:8px">
        <select id="activityType">
          <option value="walk">üö∂ ‡πÄ‡∏î‡∏¥‡∏ô</option>
          <option value="run">üèÉ ‡∏ß‡∏¥‡πà‡∏á</option>
          <option value="cycle">üö¥ ‡∏õ‡∏±‡πà‡∏ô‡∏à‡∏±‡∏Å‡∏£‡∏¢‡∏≤‡∏ô</option>
        </select>
        <select id="routePreset">
          <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</option>
          <option value="lake2_8">Lake Loop 2.8 km</option>
          <option value="run5_2">Extended Park Run 5.2 km</option>
          <option value="cycle8_5">City Cycle 8.5 km</option>
        </select>
        <button id="btnStart" class="btn-primary">‚ñ∂ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</button>
        <button id="btnStop" class="btn-danger" disabled>‚ñ† ‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      </div>
      <div id="liveStatus" class="muted" style="min-height:20px"></div>

      <details style="margin-top:6px">
        <summary class="muted">‡∏Å‡∏£‡∏ì‡∏µ GPS ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (‡πÉ‡∏™‡πà‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏≠‡∏á)</summary>
        <div class="row" style="margin-top:8px">
          <input id="manualKm" placeholder="‡πÄ‡∏ä‡πà‡∏ô 2.4 (‡∏Å‡∏°.)" />
          <button id="btnManualSave" class="btn-ghost">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
          <button id="btnQuick1" class="btn-ghost">+1 ‡∏Å‡∏°.</button>
        </div>
      </details>
    </section>

    <!-- ‡πÅ‡∏ï‡πâ‡∏° & ‡πÅ‡∏•‡∏Å‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå -->
    <section class="card">
      <div class="kicker">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô & ‡πÅ‡∏•‡∏Å‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</div>
      <div style="margin-bottom:8px">
        <b>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:</b> <span id="points">0 pts</span>
        <div class="muted">‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤: 1 ‡πÅ‡∏ï‡πâ‡∏° / 400 ‡πÄ‡∏°‡∏ï‡∏£, ‡πÄ‡∏û‡∏î‡∏≤‡∏ô/‡∏ß‡∏±‡∏ô 100 ‡πÅ‡∏ï‡πâ‡∏°, ‡∏™‡∏ï‡∏£‡∏µ‡∏Ñ x1.2 (‚â•3‡∏ß‡∏±‡∏ô) / x1.5 (‚â•7‡∏ß‡∏±‡∏ô)</div>
      </div>
      <div style="margin-bottom:8px">
        <button class="reward-btn btn-ghost" onclick="redeemReward('Healthy Bowl 10%','HB',120)">ü•ó Healthy Bowl 10% (120)</button>
        <button class="reward-btn btn-ghost" onclick="redeemReward('‡∏ô‡πâ‡∏≥‡πÄ‡∏ï‡∏¥‡∏°‡∏ü‡∏£‡∏µ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á','WTR',60)">üíß ‡∏ô‡πâ‡∏≥‡πÄ‡∏ï‡∏¥‡∏°‡∏ü‡∏£‡∏µ (60)</button>
      </div>
      <div id="redeemMsg" class="ok"></div>
      <table style="margin-top:8px">
        <thead><tr><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</th><th>‡πÇ‡∏Ñ‡πâ‡∏î</th></tr></thead>
        <tbody id="redeemTable"></tbody>
      </table>
    </section>

    <!-- ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ & ‡∏ä‡∏≤‡πÄ‡∏•‡∏ô‡∏à‡πå -->
    <section class="card">
      <div class="kicker">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</div>
      <table>
        <thead><tr><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th>‡∏Å‡∏°.</th><th>‡πÅ‡∏ï‡πâ‡∏°</th></tr></thead>
        <tbody id="historyTable"></tbody>
      </table>
      <div class="row" style="margin-top:10px;justify-content:space-between">
        <div class="muted">‡∏ä‡∏≤‡πÄ‡∏•‡∏ô‡∏à‡πå:</div>
        <div class="row">
          <button class="btn-ghost" onclick="joinChallenge()">Join 5k-a-day</button>
          <span id="challengeState" class="pill">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</span>
        </div>
      </div>
    </section>

  </main>

  <script>
    // ===== Local DB helpers =====
    const DB = {
      load(key, def){ try{ return JSON.parse(localStorage.getItem(key) || JSON.stringify(def)); } catch(e){ return def; } },
      save(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
    };

    // ===== Profile (Onboarding) =====
    function loadProfile(){ return DB.load('mtfm_profile', null); }
    function saveProfile(p){ DB.save('mtfm_profile', p); }
    function showOnboard(show){ const el = document.getElementById('onboard'); if (el) el.style.display = show ? 'flex' : 'none'; }

    function recommendText(goal){
      switch(goal){
        case 'loss': return '‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏î‡∏¥‡∏ô/‡∏ß‡∏¥‡πà‡∏á 2.8 ‡∏Å‡∏°. (Lake Loop) ‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡∏±‡∏ô + ‡∏Ñ‡∏∏‡∏°‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà + ‡∏î‡∏∑‡πà‡∏°‡∏ô‡πâ‡∏≥ 2 ‡∏•‡∏¥‡∏ï‡∏£';
        case 'fit': return '‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ß‡∏¥‡πà‡∏á 5.2 ‡∏Å‡∏°. ‡πÅ‡∏ö‡∏ö‡∏à‡πä‡∏≠‡∏Å‡∏ä‡πâ‡∏≤ + ‡πÄ‡∏ß‡∏ó 2 ‡∏ß‡∏±‡∏ô/‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô';
        case 'endurance': return '‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏õ‡∏±‡πà‡∏ô 8.5 ‡∏Å‡∏°. ‡∏£‡∏±‡∏Å‡∏©‡∏≤ HR ‡πÇ‡∏ã‡∏ô 2‚Äì3 ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏•‡∏∞ 3 ‡∏ß‡∏±‡∏ô';
        case 'muscle': return '‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏£‡πá‡∏ß 2 ‡∏Å‡∏°. ‡∏ß‡∏≠‡∏£‡πå‡∏° + ‡πÄ‡∏ß‡∏ó 3 ‡∏ß‡∏±‡∏ô/‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå ‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô 1.6‚Äì2.2 g/kg';
        case 'health': return '‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ 5‚Äì8k ‡∏Å‡πâ‡∏≤‡∏ß/‡∏ß‡∏±‡∏ô + ‡∏ú‡∏±‡∏Å‡∏ú‡∏•‡πÑ‡∏°‡πâ 400 ‡∏Å‡∏£‡∏±‡∏°/‡∏ß‡∏±‡∏ô + ‡∏ô‡∏≠‡∏ô 7‚Äì8 ‡∏ä‡∏°.';
        default: return '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß';
      }
    }

    function renderProfile(){
      const p = loadProfile() || {};
      const sum = `${p.name || '‚Äî'} ‚Ä¢ ${p.phone || ''} ‚Ä¢ ${p.email || ''} ‚Ä¢ goal: ${p.goal || '‚Äî'} ‚Ä¢ body: ${p.body || '‚Äî'}`;
      document.getElementById('profileSummary').textContent = sum;
      document.getElementById('recText').textContent = recommendText(p.goal);
    }

    function initOnboarding(){
      const p = loadProfile();
      showOnboard(!p);
      const btnSave = document.getElementById('btnSaveProfile');
      const btnSkip = document.getElementById('btnSkipProfile');
      const btnEdit = document.getElementById('btnEditProfile');

      btnSave.addEventListener('click', ()=>{
        const name = document.getElementById('pf_name').value.trim();
        const phone = document.getElementById('pf_phone').value.trim();
        const email = document.getElementById('pf_email').value.trim();
        const goal = document.getElementById('pf_goal').value;
        const body = document.getElementById('pf_body').value.trim();
        if(!name || !email){ document.getElementById('onboardMsg').textContent='‡∏Å‡∏£‡∏≠‡∏Å ‡∏ä‡∏∑‡πà‡∏≠ ‡πÅ‡∏•‡∏∞ Gmail ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢'; return; }
        saveProfile({name, phone, email, goal, body, ts: Date.now()});
        showOnboard(false); renderProfile();
      });
      btnSkip.addEventListener('click', ()=> showOnboard(false));
      btnEdit.addEventListener('click', ()=>{
        const p = loadProfile() || {};
        document.getElementById('pf_name').value = p.name || '';
        document.getElementById('pf_phone').value = p.phone || '';
        document.getElementById('pf_email').value = p.email || '';
        document.getElementById('pf_goal').value = p.goal || '';
        document.getElementById('pf_body').value = p.body || '';
        showOnboard(true);
      });
    }

    // ===== State =====
    let state = {
      active: null,
      activities: DB.load('mtfm_activities', []),
      points: DB.load('mtfm_points', 0),
      redemptions: DB.load('mtfm_redemptions', []),
      challenge: DB.load('mtfm_challenge', null)
    };

    // ===== Config =====
    const POINT_PER_M = 1/400;
    const DAILY_CAP = 100;

    // ===== Utilities =====
    const fmtTime = (d) => new Date(d).toLocaleString();
    function calcStreakDays(acts){
      const days = new Set(acts.map(a => new Date(a.ts).toDateString()));
      let streak = 0;
      for(let i=0;i<365;i++){
        const d = new Date(); d.setDate(d.getDate()-i);
        if(days.has(d.toDateString())) streak++; else break;
      }
      return streak;
    }
    function todaysPoints(acts){
      const today = new Date().toDateString();
      return acts.filter(a => new Date(a.ts).toDateString() === today)
                 .reduce((s,a)=> s + (a.pts||0), 0);
    }

    // ===== Map init =====
    const center = [13.9113,100.5486]; // ‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ó‡∏≠‡∏á
    const map = L.map('map').setView(center, 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OSM'}).addTo(map);

    function addPolyline(coords, color, name, km, type){
      const layer = L.polyline(coords,{weight:5,opacity:0.9,color}).addTo(map);
      layer.bindPopup(`<b>${name}</b><br>${km} ‚Ä¢ ${type}`);
      return layer;
    }

    const ROUTES = {
      lake2_8: { name: 'Lake Loop', km: 2.8, type:'Walk', color:'#2563eb', coords:[
        [13.9138,100.5494],[13.9132,100.5507],[13.9122,100.5520],[13.9108,100.5525],
        [13.9097,100.5517],[13.9092,100.5502],[13.9096,100.5488],[13.9108,100.5478],
        [13.9123,100.5476],[13.9135,100.5483],[13.9138,100.5494]
      ]},
      run5_2: { name: 'Extended Park Run', km:5.2, type:'Run', color:'#16a34a', coords:[
        [13.9145,100.5518],[13.9129,100.5532],[13.9109,100.5532],[13.9095,100.5519],
        [13.9087,100.5496],[13.9092,100.5474],[13.9112,100.5464],[13.9131,100.5471],
        [13.9146,100.5486],[13.9145,100.5518]
      ]},
      cycle8_5: { name: 'City Cycle Loop', km:8.5, type:'Cycle', color:'#d97706', coords:[
        [13.9160,100.5525],[13.9145,100.5550],[13.9115,100.5556],[13.9085,100.5540],
        [13.9068,100.5512],[13.9075,100.5480],[13.9095,100.5455],[13.9120,100.5448],
        [13.9148,100.5458],[13.9162,100.5488],[13.9160,100.5525]
      ]}
    };
    Object.values(ROUTES).forEach(r => addPolyline(r.coords, r.color, r.name, `${r.km} km`, r.type));

    const POIS = [
      {pos:[13.9127,100.5499], label:'Water Refill Station'},
      {pos:[13.9102,100.5512], label:'Clinic / First Aid'},
      {pos:[13.9088,100.5468], label:'Healthy Bowl @ BeeHive'},
      {pos:[13.9138,100.5460], label:'Fresh&Fill Water'},
      {pos:[13.9148,100.5524], label:'Fitness MT'}
    ];
    POIS.forEach(p => L.marker(p.pos).addTo(map).bindPopup(p.label));

    const legend = L.control({position:'bottomleft'});
    legend.onAdd = ()=>{
      const div = L.DomUtil.create('div','legend');
      div.innerHTML = `
        <div><span style="display:inline-block;width:12px;height:3px;background:#2563eb;margin-right:6px;"></span>Walk</div>
        <div><span style="display:inline-block;width:12px;height:3px;background:#16a34a;margin-right:6px;"></span>Run</div>
        <div><span style="display:inline-block;width:12px;height:3px;background:#d97706;margin-right:6px;"></span>Cycle</div>`;
      return div;
    };
    legend.addTo(map);

    // ===== UI refs =====
    const activityType = document.getElementById('activityType');
    const routePreset = document.getElementById('routePreset');
    const btnStart = document.getElementById('btnStart');
    const btnStop = document.getElementById('btnStop');
    const liveStatus = document.getElementById('liveStatus');
    const manualKm = document.getElementById('manualKm');
    const btnManualSave = document.getElementById('btnManualSave');
    const pointsEl = document.getElementById('points');
    const historyTable = document.getElementById('historyTable');
    const redeemTable = document.getElementById('redeemTable');
    const redeemMsg = document.getElementById('redeemMsg');
    const challengeState = document.getElementById('challengeState');
    const streakPill = document.getElementById('streakPill');

    // ===== Render =====
    function renderPoints(){ pointsEl.textContent = `${Math.floor(state.points)} pts`; }
    function renderHistory(){
      historyTable.innerHTML = '';
      [...state.activities].reverse().forEach(a=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${fmtTime(a.ts)}</td><td>${a.type}</td><td>${a.km.toFixed(2)}</td><td>${a.pts}</td>`;
        historyTable.appendChild(tr);
      });
      const streak = calcStreakDays(state.activities);
      streakPill.textContent = `streak ${streak} ‡∏ß‡∏±‡∏ô`;
    }
    function renderRedemptions(){
      redeemTable.innerHTML = '';
      [...state.redemptions].reverse().forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${fmtTime(r.ts)}</td><td>${r.title}</td><td>${r.code}</td>`;
        redeemTable.appendChild(tr);
      });
    }

    // ===== Activity tracking =====
    let watchId = null;
    let lastCoord = null;

    function distanceMeters(a,b){
      const toRad = d=> d*Math.PI/180;
      const R = 6371000;
      const dLat = toRad(b.lat - a.lat);
      const dLng = toRad(b.lng - a.lng);
      const lat1 = toRad(a.lat);
      const lat2 = toRad(b.lat);
      const x = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLng/2)**2;
      return 2*R*Math.asin(Math.sqrt(x));
    }

    function startActivity(){
      if(state.active) return;
      state.active = { type: activityType.value, start: Date.now(), coords: [], routePreset: routePreset.value || null };
      liveStatus.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‚Ä¶ ‡∏ñ‡πâ‡∏≤‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏≤‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î GPS/‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ preset/‡πÉ‡∏™‡πà‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏≠‡∏á';
      btnStart.disabled = true; btnStop.disabled = false;

      if (navigator.geolocation && (location.protocol.startsWith('http'))){
        watchId = navigator.geolocation.watchPosition(pos=>{
          const c = { lat: pos.coords.latitude, lng: pos.coords.longitude, t: Date.now() };
          state.active.coords.push(c);
          if(lastCoord){
            const d = distanceMeters(lastCoord, c);
            if (d>5 && d<2000){
              L.polyline([[lastCoord.lat,lastCoord.lng],[c.lat,c.lng]], {color:'#22c55e',weight:3,opacity:0.5}).addTo(map);
            }
          }
          lastCoord = c;
        }, err=>{
          console.warn('GPS error', err);
          liveStatus.textContent = 'GPS ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‚Äî ‡πÉ‡∏™‡πà‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á';
        }, { enableHighAccuracy:true, maximumAge:3000, timeout:10000 });
      } else {
        liveStatus.textContent = '‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö (file://) ‚Äî ‡πÉ‡∏™‡πà‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á';
      }
    }

    function presetKm(){
      const key = routePreset.value;
      if(!key) return null;
      const r = ROUTES[key];
      return r ? r.km : null;
    }

    function stopActivity(){
      if(!state.active) return;
      if (watchId){ navigator.geolocation.clearWatch(watchId); watchId = null; }
      btnStart.disabled = false; btnStop.disabled = true;

      // compute km
      let total = 0;
      for(let i=1;i<state.active.coords.length;i++){
        total += distanceMeters(state.active.coords[i-1], state.active.coords[i]);
      }
      let km = total/1000;

      // fallback
      if ((!km || km < 0.1) && !presetKm()){
        const ans = prompt('‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• GPS ‚Äî ‡πÉ‡∏™‡πà‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á (‡∏Å‡∏°.) ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏≥‡πÑ‡∏î‡πâ:', '1.0');
        const v = parseFloat(ans || '0');
        if (!isNaN(v) && v > 0) { km = v; }
      }
      if (!km || km < 0.1){ km = presetKm() || 1.0; }

      const duration_s = Math.round((Date.now()-state.active.start)/1000);

      // points (cap + streak bonus)
      const basePts = km*1000*POINT_PER_M;
      const todayPts = todaysPoints(state.activities);
      const remain = Math.max(0, DAILY_CAP - todayPts);
      let pts = Math.floor(Math.max(0, Math.min(basePts, remain)));

      const streakDays = calcStreakDays(state.activities.concat([{ts: Date.now()}]));
      let bonus = 1.0;
      if (streakDays >= 7) bonus = 1.5;
      else if (streakDays >= 3) bonus = 1.2;
      pts = Math.floor(pts * bonus);

      const rec = { ts: Date.now(), type: state.active.type, km, duration_s, pts, streakDays };
      state.activities.push(rec);
      state.points += pts;
      DB.save('mtfm_activities', state.activities);
      DB.save('mtfm_points', state.points);

      liveStatus.textContent = `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß: ${km.toFixed(2)} ‡∏Å‡∏°., +${pts} ‡πÅ‡∏ï‡πâ‡∏° (streak ${streakDays} ‡∏ß‡∏±‡∏ô)`;
      state.active = null; lastCoord = null;
      renderPoints(); renderHistory();
    }

    function manualSave(){
      const v = parseFloat(manualKm.value || '0');
      if (v <= 0){ liveStatus.textContent = '‡∏£‡∏∞‡∏¢‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0'; return; }
      const km = v;
      const basePts = km*1000*POINT_PER_M;
      const todayPts = todaysPoints(state.activities);
      const remain = Math.max(0, DAILY_CAP - todayPts);
      let pts = Math.floor(Math.max(0, Math.min(basePts, remain)));
      const streakDays = calcStreakDays(state.activities.concat([{ts: Date.now()}]));
      let bonus = 1.0;
      if (streakDays >= 7) bonus = 1.5;
      else if (streakDays >= 3) bonus = 1.2;
      pts = Math.floor(pts * bonus);
      const rec = { ts: Date.now(), type: activityType.value, km, duration_s: 0, pts, streakDays };
      state.activities.push(rec);
      state.points += pts;
      DB.save('mtfm_activities', state.activities);
      DB.save('mtfm_points', state.points);
      manualKm.value='';
      liveStatus.textContent = `‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏°‡∏∑‡∏≠: ${km.toFixed(2)} ‡∏Å‡∏°., +${pts} ‡πÅ‡∏ï‡πâ‡∏°`;
      renderPoints(); renderHistory();
    }

    // ===== Rewards =====
    function redeemReward(title, codePrefix, cost){
      if (state.points < cost){ redeemMsg.textContent = '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠'; return; }
      state.points -= cost;
      const code = codePrefix + '-' + Math.random().toString(36).slice(2,8).toUpperCase();
      const rec = { ts: Date.now(), title, code };
      state.redemptions.push(rec);
      DB.save('mtfm_points', state.points);
      DB.save('mtfm_redemptions', state.redemptions);
      redeemMsg.textContent = `‡πÅ‡∏•‡∏Å‡πÅ‡∏•‡πâ‡∏ß: ${title} ‚Ä¢ ‡πÇ‡∏Ñ‡πâ‡∏î ${code}`;
      renderPoints(); renderRedemptions();
    }

    // ===== Challenge =====
    function joinChallenge(){
      if (state.challenge){ challengeState.textContent = `‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°: ${state.challenge.name}`; return; }
      state.challenge = { name: '5k-a-day', joined_at: Date.now() };
      DB.save('mtfm_challenge', state.challenge);
      challengeState.textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°: 5k-a-day';
    }

    // ===== Wire up =====
    document.getElementById('btnStart').addEventListener('click', startActivity);
    document.getElementById('btnStop').addEventListener('click', stopActivity);
    document.getElementById('btnManualSave').addEventListener('click', manualSave);
    document.getElementById('btnQuick1').addEventListener('click', ()=>{
      const cur = parseFloat(manualKm.value || '0');
      manualKm.value = (isNaN(cur)?0:cur) + 1;
    });

    // Initial render
    renderProfile();
    renderPoints(); renderHistory(); renderRedemptions();
    if (state.challenge) challengeState.textContent = `‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°: ${state.challenge.name}`;
    initOnboarding();

    // PWA register (‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ô‡∏ö‡∏ô https ‡∏´‡∏£‡∏∑‡∏≠ localhost)
    if ('serviceWorker' in navigator && (location.protocol === 'https:' || location.hostname === 'localhost')){
      navigator.serviceWorker.register('./service-worker.js').catch(()=>{});
    }
  </script>
</body>
</html>
